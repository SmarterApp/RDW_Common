package org.opentestsystem.rdw.archive;

import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.model.ObjectMetadata;
import org.junit.Before;
import org.junit.Test;
import org.mockito.ArgumentCaptor;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

public class S3ArchiveServiceTest {

    private S3ArchiveService archiveService;
    private AmazonS3 amazonS3;
    private final String bucket = "bucket";
    private final String archiveRoot = "s3://" + bucket;

    @Before
    public void createArchiveService() {
        amazonS3 = mock(AmazonS3.class);
        when(amazonS3.doesBucketExist(bucket)).thenReturn(true);

        archiveService = new S3ArchiveService(amazonS3, archiveRoot, "AES256");
    }

    @Test(expected = IllegalArgumentException.class)
    public void itRequiresAS3Scheme() {
        new S3ArchiveService(amazonS3, "/tmp", null);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itRequiresAnExistingBucket() {
        when(amazonS3.doesBucketExist(bucket)).thenReturn(false);
        new S3ArchiveService(amazonS3, archiveRoot, null);
    }

    @Test
    public void itShouldUseClientForExists() {
        final String location = "TEST/f1/f2/test";
        when(amazonS3.doesObjectExist(bucket, location)).thenReturn(false).thenReturn(true);
        assertThat(archiveService.exists(location)).isFalse();
        assertThat(archiveService.exists(location)).isTrue();
    }

    @Test
    public void itShouldUseClientForWrite() {
        final String location = "TEST/f1/f2/test";
        final byte[] content = "payload".getBytes();
        archiveService.writeResource(location, content, null);

        final ArgumentCaptor<ObjectMetadata> captor = ArgumentCaptor.forClass(ObjectMetadata.class);
        verify(amazonS3).putObject(eq(bucket), eq(location), any(), captor.capture());
        assertThat(captor.getValue().getSSEAlgorithm()).isEqualTo("AES256");
    }
}
