package org.opentestsystem.rdw.common.model.subject;

import com.ctc.wstx.exc.WstxValidationException;
import com.google.common.collect.ImmutableList;
import org.junit.Before;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.net.URI;
import java.util.concurrent.atomic.AtomicInteger;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.assertj.core.api.Assertions.assertThat;

public class XmlSubjectSerializationServiceTest {

    private AtomicInteger claimIdx;
    private XmlSubjectSerializationService service;

    @Before
    public void setup() {
        claimIdx = new AtomicInteger(1);
        service = new XmlSubjectSerializationService();
    }

    @Test
    public void itShouldSerializeAndDeserializeSubjectAsXML() throws Exception {
        final Subject subject = Subject.builder()
                .code("tst")
                .name("Test")
                .subjectMessages(ImmutableList.of(
                        SubjectMessage.builder()
                                .key("subjectDescription")
                                .value("This column reflects the Common Core State Standard(s) associated with a test item. Test items may be associated with more than one standard.  Items that assess mathematical practices (problem solving, modeling and data analysis, and communicating reasoning) are also aligned to standards that describe the mathematical content with which students engage. For example, an item may ask students to communicate their reasoning when solving a problem about geometry or fractions. For more information, see the <a href=\\\"https://portal.smarterbalanced.org/library/en/mathematics-content-specifications.pd\\\" target=\\\"_blank\\\">Mathematics Content Specifications</a>.")
                                .build()))
                .assessmentTypes(ImmutableList.of(assessmentType("iab"), assessmentType("ica"), assessmentType("sum")))
                .depthsOfKnowledge(ImmutableList.of(depthOfKnowledge(1), depthOfKnowledge(2), depthOfKnowledge(3)))
                .itemDifficulties(ImmutableList.of(itemDifficulty(1), itemDifficulty(2)))
                .reportGrades(ImmutableList.of(reportGrade("03"), reportGrade("04")))
                .claims(ImmutableList.of(
                        claim("scorable", true, false),
                        claim("org", false, true),
                        claim("both", true, true)))
                .standards(ImmutableList.of(standard("std.0.1"), standard("std.0.2")))
                .build();

        final String xmlValue = service.serializeSubject(subject);
        assertThat(xmlValue).isNotEmpty();

        try(final ByteArrayInputStream input = new ByteArrayInputStream(xmlValue.getBytes(UTF_8))) {
            final Subject deserialized = service.parseSubject(input);
            assertThat(subject).isEqualToComparingFieldByFieldRecursively(deserialized);
        }
    }

    @Test
    public void itShouldValidateXMLAgainstTheXSD() {
        final String invalidXml = "<Subject code=\"blah\" name=\"Blah\"/>";
        IOException expectedException = null;
        try (final ByteArrayInputStream input = new ByteArrayInputStream(invalidXml.getBytes(UTF_8))) {
            service.parseSubject(input);
        } catch (final IOException e) {
            expectedException = e;
        }
        assertThat(expectedException).isNotNull();
        assertThat(expectedException.getCause()).isInstanceOf(WstxValidationException.class);
        assertThat(expectedException.getCause().getMessage()).isNotBlank();
    }

    private ReportGrade reportGrade(final String gradeCode) {
        return ReportGrade.builder()
                .code(gradeCode)
                .reportAssessmentTypes(ImmutableList.of(
                        ReportAssessmentType.builder()
                                .code("ica")
                                .overallAchievementMessage("Overall Grade Message " + gradeCode)
                                .reportClaims(ImmutableList.of(
                                        ReportClaim.builder()
                                                .code("SOCK_2")
                                                .performanceLevels(ImmutableList.of(
                                                        reportPerformanceLevel(1),
                                                        reportPerformanceLevel(2),
                                                        reportPerformanceLevel(3)
                                                ))
                                                .build()
                                ))
                                .reportPerformanceLevels(ImmutableList.of(
                                        reportPerformanceLevel(1),
                                        reportPerformanceLevel(2),
                                        reportPerformanceLevel(3),
                                        reportPerformanceLevel(4)))
                                .build()
                ))
                .build();
    }

    private ReportPerformanceLevel reportPerformanceLevel(final int performanceLevel) {
        return ReportPerformanceLevel.builder()
                .description("ReportPerformanceLevel Description " + performanceLevel)
                .level(performanceLevel)
                .build();
    }

    private ItemClaim claim(final String code, final boolean scorable, final boolean organizational) {
        return ItemClaim.builder()
                .code(code)
                .name("Claim " + code)
                .scorable(scorable)
                .organizational(organizational)
                .displayOrder(scorable ? claimIdx.getAndIncrement() : null)
                .icon(scorable ? "icon_" + code : null)
                .description("Description " + code)
                .targets(organizational
                        ? ImmutableList.of(target(code, "OA|1"), target(code, "OA|2"))
                        : null)
                .build();
    }

    private Target target(final String claimCode, final String targetCode) {
        return Target.builder()
                .code(claimCode + "|" + targetCode)
                .name("Target name " + targetCode)
                .description("Target description " + targetCode)
                .build();
    }

    private SubjectAssessmentType assessmentType(final String typeCode) {
        return SubjectAssessmentType.builder()
                .code(typeCode)
                .performanceLevels(PerformanceLevels.builder()
                        .standardCutoff(2)
                        .performanceLevels(ImmutableList.of(performanceLevel(1), performanceLevel(2),  performanceLevel(3), performanceLevel(4)))
                        .build())
                .subScoring(typeCode.equals("iab")
                        ? null
                        : SubScoring.builder()
                        .performanceLevels(PerformanceLevels.builder()
                                .performanceLevels(ImmutableList.of(performanceLevel(1), performanceLevel(2), performanceLevel(3)))
                                .build())
                        .build())
                .build();
    }

    private DepthOfKnowledge depthOfKnowledge(final int depth) {
        return DepthOfKnowledge.builder()
                .name("Depth " + depth)
                .level(depth)
                .reference(URI.create("http://depth.of.knowledge.com/" + depth + ".pdf"))
                .build();
    }

    private ItemDifficulty itemDifficulty(final int idx) {
        return ItemDifficulty.builder()
                .gradeCode("03")
                .moderateLowEnd(idx - 0.1)
                .difficultLowEnd(idx + 0.1)
                .build();
    }

    private PerformanceLevel performanceLevel(final int level) {
        return PerformanceLevel.builder()
                .level(level)
                .name("Level " + level)
                .color("blue")
                .build();
    }

    private Standard standard(final String code) {
        return Standard.builder()
                .code(code)
                .description("Description " + code)
                .build();
    }
}
