package org.opentestsystem.rdw.multitenant;

import org.apache.tomcat.jdbc.pool.PoolProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;

import javax.sql.DataSource;
import java.util.Optional;

/**
 * Tenant specific {@link AbstractDynamicRoutingDataSource} defers
 * to {@link TenantDataSourceOverrideResolver} for tenant specific
 * datasource url, username, and password.
 * Otherwise uses the supplied {@link DataSourceProperties}
 */
public class TenantDynamicRoutingDataSource extends AbstractDynamicRoutingDataSource {

    //TODO: this interim default is only in place while we have a single tenant
    public static final String DEFAULT_TENANT_ID = "DEFAULT_TENANT";

    private static final Logger logger = LoggerFactory.getLogger(TenantDynamicRoutingDataSource.class);

    private final DataSourceElements dataSourceElements;
    private final TenantDataSourceOverrideResolver tenantDataSourceOverrideResolver;

    public TenantDynamicRoutingDataSource(DataSourceElements dataSourceElements,
                                          TenantDataSourceOverrideResolver tenantDataSourceOverrideResolver) {
        this.dataSourceElements = dataSourceElements;
        this.tenantDataSourceOverrideResolver = tenantDataSourceOverrideResolver;
    }

    @Override
    protected Object determineCurrentLookupKey() {
        final String tenantId = TenantContextHolder.getTenantId();
        if (tenantId == null) {
            logger.warn("No tenantId set in TenantContextHolder falling back to default {}", DEFAULT_TENANT_ID);
            return DEFAULT_TENANT_ID;
        }
        return tenantId;
    }

    @Override
    protected DataSource dataSourceFactory(Object lookupKey) {
        final String tenantId = (String) lookupKey;
        final TenantDatasourceOverride override = tenantDataSourceOverrideResolver.resolve(tenantId);

        logger.info("creating new dataSource for url: {} username: {} password: XXXXXXX", override.getUrl(), override.getUsername());

        PoolProperties poolProperties = new PoolProperties();

        //overrides
        poolProperties.setUrl(override.getUrl());
        poolProperties.setUsername(override.getUsername());
        poolProperties.setPassword(override.getPassword());

        //shared
        Optional.ofNullable(dataSourceElements.getDriverClassName())
                .ifPresent(poolProperties::setDriverClassName);
        Optional.ofNullable(dataSourceElements.getJdbcInterceptors())
                .ifPresent(poolProperties::setJdbcInterceptors);
        Optional.ofNullable(dataSourceElements.getTestWhileIdle())
                .ifPresent(poolProperties::setTestWhileIdle);
        Optional.ofNullable(dataSourceElements.getValidationQuery())
                .ifPresent(poolProperties::setValidationQuery);
        Optional.ofNullable(dataSourceElements.getValidationQueryTimeout())
                .ifPresent(poolProperties::setValidationQueryTimeout);
        Optional.ofNullable(dataSourceElements.getDriverClassName())
                .ifPresent(poolProperties::setDriverClassName);
        Optional.ofNullable(dataSourceElements.getInitialSize())
                .ifPresent(poolProperties::setInitialSize);
        Optional.ofNullable(dataSourceElements.getMaxActive())
                .ifPresent(poolProperties::setMaxActive);
        Optional.ofNullable(dataSourceElements.getMinIdle())
                .ifPresent(poolProperties::setMinIdle);
        Optional.ofNullable(dataSourceElements.getMaxIdle())
                .ifPresent(poolProperties::setMaxIdle);

        return new org.apache.tomcat.jdbc.pool.DataSource(poolProperties);
    }
}

