package org.opentestsystem.rdw.multitenant.cache;

import org.opentestsystem.rdw.multitenant.TenantIdResolver;
import org.springframework.cache.interceptor.KeyGenerator;

import java.lang.reflect.Method;
import java.util.StringJoiner;

/**
 * A custom cache key generator that prefixes with the current tenant id.
 * The resulting key includes the method name and stringified params, e.g. "CA_findAll".
 * <p>
 * NOTE: this is a CACHE KEY generator, it has nothing to do with tenant keys.
 * </p>
 * <p>
 * To use, create a bean using a TenantIdResolver, e.g.<pre>
 * {@literal @}Bean
 *  public KeyGenerator tenantKeyGenerator(final TenantIdResolver tenantIdResolver) {
 *      return new TenantKeyGenerator(tenantIdResolver);
 *  }
 * </pre>
 */
public class TenantKeyGenerator implements KeyGenerator {

    private final TenantIdResolver tenantIdResolver;

    public TenantKeyGenerator(final TenantIdResolver tenantIdResolver) {
        this.tenantIdResolver = tenantIdResolver;
    }

    @Override
    public Object generate(final Object target, final Method method, final Object... params) {
        return generate(method.getName(), params);
    }

    /**
     * This helper is broken out to help with integration tests.
     *
     * @param methodName method name, e.g. "findAll"
     * @param params method parameters
     * @return generated key
     */
    public Object generate(final String methodName, final Object... params) {
        final StringJoiner joiner = new StringJoiner("_");
        // i don't think we want to throw in a KeyGenerator, so use a placeholder
        joiner.add(tenantIdResolver.getTenantId().orElse("TENANT"));
        joiner.add(methodName);
        if (params != null && params.length > 0) {
            for (final Object param : params) {
                joiner.add(param.toString());
            }
        }
        return joiner.toString();
    }
}
