package org.opentestsystem.rdw.multitenant.configprops;


import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.actuate.endpoint.ConfigurationPropertiesReportEndpoint;
import org.springframework.cache.Cache;
import org.springframework.cache.CacheManager;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.cloud.context.environment.EnvironmentChangeEvent;
import org.springframework.cloud.context.refresh.ContextRefresher;
import org.springframework.context.event.EventListener;

import java.util.Objects;

/**
 * Clears all caches after a context refresh, such as would occur after the creation of a new tenant or sandbox.
 *
 * <p>
 * This class listens for {@link EnvironmentChangeEvent}.
 * It is fired after {@link ContextRefresher#refresh()} completes,
 * and beans that use {@link RefreshScope} will have been updated by then.
 * The message is extracted from {@link ConfigurationPropertiesReportEndpoint}
 */
public class ConfigurationChangeListener {
    private static final Logger logger = LoggerFactory.getLogger(ConfigurationChangeListener.class);

    private final CacheManager cacheManager;

    public ConfigurationChangeListener(final CacheManager cacheManager) {
        this.cacheManager = cacheManager;
    }

    /**
     * Listen for {@link EnvironmentChangeEvent} and clear all caches
     *
     * @param environmentChangeEvent event payload
     */
    @EventListener
    public void environmentChangeEventClearCaches(final EnvironmentChangeEvent environmentChangeEvent) {
        logger.debug("EnvironmentChangeEvent - {}", environmentChangeEvent);
        try {
            // Clear all caches listed in CacheManager
            cacheManager.getCacheNames()
                    .stream()
                    .map(cacheManager::getCache)
                    .filter(Objects::nonNull)
                    .forEach(Cache::clear);
        } catch (Exception e) {
            //no end user log only
            logger.warn("Unable to clear cache", e);
        }
    }
}
