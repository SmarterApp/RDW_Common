package org.opentestsystem.rdw.script;

import groovy.lang.GroovyClassLoader;
import org.apache.commons.lang3.StringUtils;
import org.codehaus.groovy.control.CompilationFailedException;

/**
 * Compiles a script into a class with the given class loader.
 */
public class ScriptCompiler {
    private final GroovyClassLoader classLoader;

    public ScriptCompiler(GroovyClassLoader classLoader) {
        this.classLoader = classLoader;
    }

    public Class<? extends PipelineScript> compile(final String scriptCode) throws CompilationFailedException {
        Class<?> clazz = classLoader.parseClass(scriptCode);
        return clazz.asSubclass(PipelineScript.class);
    }

    public Class<? extends PipelineScript> compile(final String scriptCode, final String name)
            throws CompilationFailedException {
        if (StringUtils.isBlank(name)) {
            return compile(scriptCode);
        }

        final String fileName = (name.endsWith(".groovy")) ? name : name + ".groovy";
        Class<?> clazz = classLoader.parseClass(scriptCode, fileName);
        return clazz.asSubclass(PipelineScript.class);
    }
}