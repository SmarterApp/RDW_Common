package org.opentestsystem.rdw.script.impl;

import org.opentestsystem.rdw.script.PipelineDefinition;
import org.opentestsystem.rdw.script.ScriptDefinition;
import org.opentestsystem.rdw.script.ScriptInfo;
import org.opentestsystem.rdw.script.ScriptSource;
import org.opentestsystem.rdw.script.publishing.PublishedPipeline;
import org.opentestsystem.rdw.script.publishing.PublishedPipelineRepository;

import static java.util.Collections.emptyMap;
import static java.util.stream.Collectors.toList;

/**
 * TODO: This is a stub. It must be replaced with a real implementation that loads scripts from an s3 bucket,
 * a private GitHub repo, or other source.
 */
public class DefaultScriptSource implements ScriptSource {

    private final PublishedPipelineRepository repository;

    public DefaultScriptSource(final PublishedPipelineRepository repository) {
        this.repository = repository;
    }

    @Override
    public PipelineDefinition loadPipelineDefinition(final String pipelineName, final String pipelineVersion) {
        final PublishedPipeline publishedPipeline = repository.findByCodeAndVersion(pipelineName, pipelineVersion);
        return PipelineDefinition.builder()
                .source(publishedPipeline)
                .scripts(
                        publishedPipeline.getScripts().stream()
                                .map(publishedScript -> ScriptDefinition.builder()
                                        .source(publishedScript)
                                        .build()
                                )
                                .collect(toList())
                )
                .build();
    }

    @Override
    public ScriptInfo loadScript(final ScriptDefinition scriptDefinition) {
        return new ScriptInfo(scriptDefinition.getSource().getBody(), emptyMap());
    }

}
