package org.opentestsystem.rdw.script.util;

import groovy.lang.GroovyRuntimeException;
import org.codehaus.groovy.control.CompilationFailedException;
import org.codehaus.groovy.control.MultipleCompilationErrorsException;
import org.codehaus.groovy.control.messages.Message;
import org.codehaus.groovy.control.messages.SyntaxErrorMessage;
import org.codehaus.groovy.syntax.SyntaxException;

import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * Converters for various Groovy error classes that extract the message the script location if possible.
 */
public class ExceptionConverter {

    public static ScriptError convert(GroovyRuntimeException e) {
        return (e.getNode() == null) ?
                new ScriptError(e.getMessage(), null, null) :
                new ScriptError(e.getMessage(), e.getNode().getLineNumber(), e.getNode().getColumnNumber());
    }

    public static ScriptError convert(SyntaxException ex) {
        return new ScriptError(ex.getOriginalMessage(), ex.getStartLine(), ex.getStartColumn());
    }

    public static List<ScriptError> convert(CompilationFailedException e) {
        if (e instanceof MultipleCompilationErrorsException) {
            return convert((MultipleCompilationErrorsException)e);
        } else {
            return Collections.singletonList(convert((GroovyRuntimeException)e));
        }
    }

    public static List<ScriptError> convert(MultipleCompilationErrorsException e) {
        if (e.getErrorCollector() == null
                || e.getErrorCollector().getErrors() == null
                || e.getErrorCollector().getErrors().isEmpty())
        {
            return Collections.singletonList(convert((GroovyRuntimeException) e));
        }

        final List<ScriptError> errorsList = new ArrayList<>();

        for (Object error : e.getErrorCollector().getErrors()) {
            if (error instanceof SyntaxErrorMessage) {
                SyntaxException exception = ((SyntaxErrorMessage) error).getCause();
                errorsList.add(convert(exception));
            } else if (error instanceof Message) {
                Message message = (Message)error;
                final StringWriter stringWriter = new StringWriter();
                message.write(new PrintWriter(stringWriter));
                errorsList.add(new ScriptError(stringWriter.toString(), null, null));
            }
        }

        return errorsList;
    }
}
