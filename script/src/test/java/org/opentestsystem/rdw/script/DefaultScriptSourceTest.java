package org.opentestsystem.rdw.script;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.script.impl.DefaultScriptSource;
import org.opentestsystem.rdw.script.publishing.PublishedPipeline;
import org.opentestsystem.rdw.script.publishing.PublishedPipelineRepository;
import org.opentestsystem.rdw.script.publishing.PublishedScript;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class DefaultScriptSourceTest {

    @Mock
    private PublishedPipelineRepository repository;

    private DefaultScriptSource scriptSource;

    @Before
    public void createScriptSource() {
        scriptSource = new DefaultScriptSource(repository);
    }

    @Test
    public void itShouldLoadTheScriptBase() {
        assertThat(scriptSource.loadScriptBaseClass())
                .contains("DSLScriptBase")
                .contains("PipelineScript");
    }

    @Test
    public void itShouldLoadPipelineDefinition() {

        final String code = "code";
        final String version = "1.0";

        when(repository.findByCodeAndVersion(code, version))
                .thenReturn(
                        PublishedPipeline.builder()
                                .pipelineCode(code)
                                .version(version)
                                .build()
                );

        assertThat(scriptSource.loadPipelineDefinition(code, version))
                .isEqualToComparingFieldByFieldRecursively(
                        PipelineDefinition.builder()
                                .name(code)
                                .version(version)
                                .type(ResourceType.PIPELINE)
                                .nodeDefinitions(newArrayList(
                                ))
                        .build()
                );
    }

    @Test
    public void isShouldLoadScript() {
        final ScriptDefinition node = ScriptDefinition.builder()
                .name("exam_script")
                .version("")
                .type(ResourceType.USER_NODE)
                .source(
                        PublishedScript.builder()
                                .body("enable 'xml'")
                                .build()
                )
                .build();

        assertThat(scriptSource.loadScript(node).getCode())
                .isEqualTo(node.getSource().getBody());
    }
}
