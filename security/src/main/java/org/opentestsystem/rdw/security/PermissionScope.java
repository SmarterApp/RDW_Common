package org.opentestsystem.rdw.security;

import com.google.common.collect.ImmutableSet;

import java.io.Serializable;
import java.util.Collection;
import java.util.List;
import java.util.Set;

import static com.google.common.collect.Lists.newArrayList;

/**
 * A permission scope defines the level associated with a granted permission. This level is
 * either statewide, applying to all organizations for the system state (e.g. "CA") or it is a
 * collection of district, school, group ids.
 *
 * The permission scope is used to limit database query results. All of the ids are database ids.
 */
public class PermissionScope implements Serializable {

    /**
     * Statewide permission scope flyweight
     * Since all statewide permission scopes will be identical, we can use the same immutable object instance
     */
    public static final PermissionScope STATEWIDE = new PermissionScope(true);

    /**
     * Empty permission scope flyweight
     */
    public static final PermissionScope EMPTY = new PermissionScope(false);

    private final Set<Long> districtGroupIds;
    private final Set<Long> districtIds;
    private final Set<Long> institutionGroupIds;
    private final Set<Long> institutionIds;
    private final boolean statewide;

    private PermissionScope(final boolean statewide) {
        this.districtGroupIds = ImmutableSet.of();
        this.districtIds = ImmutableSet.of();
        this.institutionGroupIds = ImmutableSet.of();
        this.institutionIds = ImmutableSet.of();
        this.statewide = statewide;
    }

    /**
     * Construct a permission scope from lists of ids.
     * The statewide flag is set false.
     *
     * @param districtGroupIds optional district group ids
     * @param districtIds optional district ids
     * @param institutionGroupIds optional school group ids
     * @param institutionIds optional school ids
     */
    public PermissionScope(
            final Collection<Long> districtGroupIds,
            final Collection<Long> districtIds,
            final Collection<Long> institutionGroupIds,
            final Collection<Long> institutionIds) {
        this.districtGroupIds = districtGroupIds != null ? ImmutableSet.copyOf(districtGroupIds) : ImmutableSet.of();
        this.districtIds = districtIds != null ? ImmutableSet.copyOf(districtIds) : ImmutableSet.of();
        this.institutionGroupIds = institutionGroupIds != null ? ImmutableSet.copyOf(institutionGroupIds) : ImmutableSet.of();
        this.institutionIds = institutionIds != null ? ImmutableSet.copyOf(institutionIds) : ImmutableSet.of();
        this.statewide = false;
    }

    public boolean isStatewide() {
        return this.statewide;
    }

    public Set<Long> getDistrictGroupIds() {
        return districtGroupIds;
    }

    public Set<Long> getDistrictIds() {
        return districtIds;
    }

    public Set<Long> getInstitutionGroupIds() {
        return institutionGroupIds;
    }

    public Set<Long> getInstitutionIds() {
        return institutionIds;
    }

    public static Builder builder() {
        return new Builder();
    }


    public static class Builder {
        private boolean statewide;
        private List<Long> districtGroupIds;
        private List<Long> districtIds;
        private List<Long> schoolGroupIds;
        private List<Long> schoolIds;

        public Builder statewide(final boolean statewide) {
            this.statewide = statewide;
            return this;
        }

        public Builder addDistrictGroupId(final long id) {
            if (this.districtGroupIds == null) {
                this.districtGroupIds = newArrayList();
            }
            this.districtGroupIds.add(id);
            return this;
        }

        public Builder addDistrictId(final long id) {
            if (this.districtIds == null) {
                this.districtIds = newArrayList();
            }
            this.districtIds.add(id);
            return this;
        }

        public Builder addSchoolGroupId(final long id) {
            if (this.schoolGroupIds == null) {
                this.schoolGroupIds = newArrayList();
            }
            this.schoolGroupIds.add(id);
            return this;
        }

        public Builder addSchoolId(final long id) {
            if (this.schoolIds == null) {
                this.schoolIds = newArrayList();
            }
            this.schoolIds.add(id);
            return this;
        }

        /**
         * @return <code>true</code> if the permission scope is statewide or has any ids
         */
        public boolean isValid() {
            return statewide
                    || (districtGroupIds != null && !districtGroupIds.isEmpty())
                    || (districtIds != null && !districtIds.isEmpty())
                    || (schoolGroupIds != null && !schoolGroupIds.isEmpty())
                    || (schoolIds != null && !schoolIds.isEmpty());
        }

        public PermissionScope build() {
            return statewide ? PermissionScope.STATEWIDE
                    : new PermissionScope(districtGroupIds, districtIds, schoolGroupIds, schoolIds);
        }
    }
}

