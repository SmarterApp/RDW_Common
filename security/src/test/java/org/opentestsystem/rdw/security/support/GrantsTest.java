package org.opentestsystem.rdw.security.support;

import org.junit.Test;
import org.opentestsystem.rdw.security.Grant;

import static org.hamcrest.CoreMatchers.is;
import static org.hamcrest.MatcherAssert.assertThat;

public class GrantsTest {

	@Test(expected = NullPointerException.class)
	public void fromShouldThrowExceptionWhenStringIsNull() throws Exception {
		Grants.from(null);
	}

	@Test(expected = IllegalArgumentException.class)
	public void fromShouldThrowExceptionWhenStringHasTooLittleDelimiters() throws Exception {
		Grants.from("|||||||||||||||||");
	}

	@Test(expected = IllegalArgumentException.class)
	public void fromShouldThrowExceptionWhenStringHasTooManyDelimiters() throws Exception {
		Grants.from("|||||||||||||||||||");
	}

	@Test
	public void fromShouldNotThrowExceptionForValidGrant() throws Exception {
		Grants.from("|CA|SAREXTRACTS|STATE|98765|CA98765|||CA|CALIFORNIA|||||||||");
	}

	@Test
	public void fromShouldCorrectlyPassAllFields() throws Exception {
		final Grant grant = Grants.from("|a|b|STATE|d|e|||a|i|||l|m|n|o|p|q|");
		assertThat(grant.getEntityId(), is("a"));
		assertThat(grant.getRole(), is("b"));
		assertThat(grant.getEntityLevel(), is(Grant.EntityLevel.STATE));
		assertThat(grant.getClientId(), is("d"));
		assertThat(grant.getClientName(), is("e"));
		assertThat(grant.getStateGroupId(), is((String) null));
		assertThat(grant.getStateGroupName(), is((String) null));
		assertThat(grant.getStateId(), is("a"));
		assertThat(grant.getStateName(), is("i"));
		assertThat(grant.getDistrictGroupId(), is((String) null));
		assertThat(grant.getDistrictGroupName(), is((String) null));
		assertThat(grant.getDistrictId(), is("l"));
		assertThat(grant.getDistrictName(), is("m"));
		assertThat(grant.getInstitutionGroupId(), is("n"));
		assertThat(grant.getInstitutionGroupName(), is("o"));
		assertThat(grant.getInstitutionId(), is("p"));
		assertThat(grant.getInstitutionName(), is("q"));
	}

	@Test
	public void containsShouldReturnFalseForGrantsWithDifferentRoles() {
		final Grant a = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.CLIENT).clientId("a").build();
		final Grant b = Grant.builder().entityId("a").role("b").entityLevel(Grant.EntityLevel.CLIENT).clientId("a").build();
		assertThat("grants with different roles cannot contain one another", Grants.contains(a, b), is(false));
	}

	@Test
	public void containsShouldReturnTrueForEqualGrants() {
		final Grant a = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.CLIENT).clientId("a").build();
		final Grant b = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.CLIENT).clientId("a").build();
		assertThat("equal grants should count as contained because they are redundant", Grants.contains(a, b), is(true));
	}

	@Test
	public void containsShouldReturnTrueWhenAGrantOfLesserGranularityHasAnEntityWhichContainsAQualifierInTheOtherGrant() {
		final Grant a = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.STATE).stateId("a").build();
		final Grant b = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.DISTRICT).stateId("a").districtId("a").build();
		assertThat("a grant with lesser granularity and a matching entity qualifier should count as containing the other grant", Grants.contains(a, b), is(true));
	}

	@Test
	public void containsShouldReturnFalseIfGrantsDontHaveAnyMatchingQualifiers() {
		final Grant a = Grant.builder().entityId("a").role("a").entityLevel(Grant.EntityLevel.STATE).stateId("a").build();
		final Grant b = Grant.builder().entityId("b").role("a").entityLevel(Grant.EntityLevel.DISTRICT).stateId("b").districtId("b").build();
		assertThat("grants without matching qualifiers should not count as containing one another", Grants.contains(a, b), is(false));
	}

}
