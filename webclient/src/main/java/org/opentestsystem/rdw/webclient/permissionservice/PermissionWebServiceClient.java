package org.opentestsystem.rdw.webclient.permissionservice;

import com.google.common.collect.ImmutableMap;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;
import org.springframework.web.client.RestTemplate;

import javax.validation.constraints.NotNull;
import java.util.Map;

import static com.google.common.base.Preconditions.checkNotNull;

public class PermissionWebServiceClient {

	private RestTemplate restTemplate;
	private String endpoint;

	public PermissionWebServiceClient(@NotNull final RestTemplate restTemplate, @NotNull final String endpoint) {
		this.restTemplate = checkNotNull(restTemplate);
		this.endpoint = checkNotNull(endpoint);
	}

	public Response<Component> getComponents() {
		return get(endpoint + "/component", new ParameterizedTypeReference<Response<Component>>() {});
	}

	public Response<Component> getComponent(final String component) {
		return get(endpoint + "/component?component={component}",
			new ParameterizedTypeReference<Response<Component>>() {},
			ImmutableMap.of("component", component));
	}

	public Response<Role> getRoles() {
		return get(endpoint + "/role", new ParameterizedTypeReference<Response<Role>>() {});
	}

	public Response<Role> getRole(final String component) {
		return get(endpoint + "/role?component={component}",
			new ParameterizedTypeReference<Response<Role>>() {},
			ImmutableMap.of("component", component));
	}

	public Response<Permission> getPermissions() {
		return get(endpoint + "/permission", new ParameterizedTypeReference<Response<Permission>>() {});
	}

	private <T> T get(String url, ParameterizedTypeReference<T> typeReference) {
		return get(url, typeReference, ImmutableMap.of());
	}

	private <T> T get(String url, ParameterizedTypeReference<T> typeReference, Map<String, ?> parameters) {
		return restTemplate.exchange(url, HttpMethod.GET, null, typeReference, parameters).getBody();
	}

}
